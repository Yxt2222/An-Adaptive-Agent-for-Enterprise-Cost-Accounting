# 核价系统  
## PRD 需求分析（V0.1）

---

## 一、基本需求

### 1. 账户与行为管理
- 提供基础员工账号系统：注册、管理、登录、注销、权限控制  
- 提供**用户历史行为记录系统**，记录以下行为：
  - 登录
  - 数据上传
  - 数据修改
  - 人工确认  
- 行为记录要求：
  - 可导出
  - 可解释
  - 可审计

---

### 2. 数据本地存储与管理（以 Excel 为主）

系统需提供 **Excel 数据的本地化存储管理能力**，包括：
- 上传
- 校验
- 存储
- 读取
- 更新
- 删除

#### 数据来源与职责划分
- **设计部**
  - 上传材料清单（Excel）
  - 上传配件清单（Excel）
- **采购部**
  - 根据材料 / 配件清单完成采购
  - 上传材料与配件采购成本表（Excel）
- **生产部**
  - 根据设计图纸进行生产
  - 上传工人工资核定表
  - 上传加工耗材成本表（Excel）
- **物流 / 安装人员**
  - 上传物流费表
  - 上传安装费表

#### 数据校验要求
- 上传前进行**数据完整性校验**
- 每个表单的**核心字段必须存在**
- 若字段缺失，需定义系统处理策略（阻断 / 标记 / 人工确认）

#### 数据留存目标
系统需保留**结构化历史成本数据**，以支持：
- 成本对比
- 经验估算
- 报价参考

---

### 3. 数据分析与成本核算系统

系统需具备以下能力：
- 数据完整性检验
- 数据预处理
- 特征对齐
- 数据分析
- 成本计算
- 结果报告生成
- 报告输出与下载

#### 成本计算前置条件
在计算某项目**直接生产成本**前，必须完成项目数据完整性校验：

一个工程项目**必须同时具备**：
- 材料清单 & 材料成本表
- 配件清单 & 配件成本表
- 工资核定表
- 加工耗材表
- 物流费用表
- 安装费用表  

否则 **不允许计算项目直接成本**。

---

### 4. 前端与访问方式
- 提供前端网页图形化界面
- 用户交互友好
- 支持公司 **局域网访问**

---

### 5. 数据质量与人工确认原则（V0.1）

- 系统以 **Excel 原始数据** 为输入
- 默认数据可能存在：
  - 不完整
  - 不规范
- 处理原则：
  - **关键字段缺失** → 阻断成本计算并提示人工补全
  - **非关键字段缺失** → 允许人工确认后继续
- 所有人工修改与确认行为：
  - 必须记录
  - 用于后续审计与复盘

### 6. 一些核心问题
#### 如何处理员工的读写误操作
- 对于文件级（Excel）误操作，系统会存储上传文件的所有版本，哪怕当前文件上传的版本是错的，可以回滚历史记录到已经上传的正确的版本。
- 对于数据级（明细）误操作，靠 status + AuditLog，允许求改数据项的相关属性，但同时必须写Auditlog，人工查验合格后status从warning → confirmed。
- 对于读操作（查看 / 导出），一定要显示注明直接成本分析报告的版本号，最新版本要显著与历史版本不一样，确保财务人员拿正确的版本参考报价，
过期版本是否展示给财务人员可谨慎讨论。
#### 本地备份如果服务器故障怎么办
- 定期离线全量备份，每周自动执行：停止服务-打包数据库文件和data目录-生成backup_2025-01-15.tar.gz。备份介质可用U盘/外置硬盘/NAS。
- 服务器回复流程：新服务器 / 新电脑-安装运行环境-解压最近一次备份-启动服务。
#### 数据库能不能适配业务需求调整
- 目前的设计架构兼容以下的变化：新材料类型，新配件规格，新施工组名字，新供应商，新核价规则。
- 不兼容以下的变化，需要结构性升级：引入税费/管理费；多项目合并报价/跨年度摊销/主数据管理/ERP,MES对接。
- V0.1已经满足了核心设计需求，数据存储，安全性保障，直接成本计算。所以不是能不能用的问题，而是用到什么时候升级的问题。

---

## 二、模块化拆解

---

### 2.1 目标与范围界定（Scope Definition）

#### 核心目标（V0.1）
在保证 **数据安全** 与 **系统可扩展性** 的前提下：

> 实现对**单一产品 / 合同**的直接生产成本进行结构化核算与输出，为投标报价提供可量化依据。

#### 本版本解决的问题
- 多部门成本数据分散，依赖人工汇总
- Excel 格式不统一、字段不规范
- 成本核算过程不可追溯、不可复查
- 无法形成可积累的历史成本数据库

#### 明确不解决的问题（V0.1 排除项）
- 税费、管理费、经营奖励等全生命周期成本
- 成本预测、智能报价、AI 估算
- 公网访问、外部系统对接（ERP / PLM）
- 实时协同、多用户并发编辑

---

### 2.2 使用主体与运行假设（Operational Assumptions）

#### 使用主体
- **核心使用部门 / 数据上传与报告导出**
  - 财务部
  - 经营部
- **辅助数据来源部门**
  - 设计部
  - 采购部
  - 生产车间
  - 物流 / 安装

#### 运行假设（V0.1 前提）
- 所有业务数据均以 **Excel 文件** 形式导入
- 默认由 **财务部统一完成数据上传与校验**
- 系统运行在 **公司内网环境**
- 单产品数据量有限
- 不考虑高并发与大规模计算

---

### 2.3 功能性需求（Functional Requirements）

#### 2.3.1 账户与权限管理

系统需提供基础用户管理能力：
- 账户创建 / 删除 / 禁用
- 用户登录 / 登出
- 基于角色的访问控制（RBAC）：
  - **管理员**：系统配置、数据全权
  - **普通用户**：查看 / 受限修改
- 用户行为记录与导出

> V0.1 不涉及复杂权限树与审批流。

---

#### 2.3.2 数据文件管理（Excel 为核心）

##### 支持的文件类型
- 材料计划表（设计部）
- 配件计划表（设计部）
- 材料 / 配件采购成本表（采购部）
- 车间工时 / 加工费用表（生产部）
- 运费与安装费表（物流 / 安装）

##### 基础能力
- 文件上传、校验、存储、读取、更新、删除
- 所有文件必须绑定 **唯一业务标识**
  - 产品编号 / 合同号
- 文件变更需保留：
  - 版本记录
  - 操作日志

---

### 2.4 数据预处理与标准化（核心能力）

#### 2.4.1 字段识别与映射

系统需具备字段自动识别与映射能力，例如：
- “规格型号” ≈ “规格型号号”
- “数量” ≈ “张数 / 根数”
- “单价” ≈ “工价”

> 映射规则支持配置与人工确认。

---

#### 2.4.2 单位统一与数值标准化

系统需将多源数据统一为内部标准单位：
- 数量单位：根 / 条 / 张 → `count`
- 重量单位：吨 / kg → `kg`
- 金额单位：统一为人民币元

> 理论重量自动计算在 V0.1 中为**可选能力**，非强制。

---

#### 2.4.3 数据校验与异常检测

系统需进行基础数据质量校验，包括：
- 关键字段缺失（数量、单价、金额）
- 数值异常（负数、极端值）
- 小计 ≠ 数量 × 单价
- 设计量 / 采购量 / 实际用量偏差

异常数据需：
- 明确标识
- 支持人工确认与修改

---

### 2.5 特征对齐与多源合并（Data Alignment）

系统需将多部门数据对齐至统一内部结构。

#### 统一内部结构示例
- **材料**
  - material_name, spec, quantity, unit, weight, price, subtotal
- **配件**
  - part_name, model, quantity, price, subtotal
- **人工**
  - group_name, weight, fee_per_ton, bonus, subtotal

#### 对齐规则
- 所有数据必须绑定同一 **产品 ID**
- 支持同一产品多文件合并
- 自动检测设计量与采购量偏差
- 不自动篡改数据，仅提示或要求人工确认

---

### 2.6 人工确认与降级机制（V0.1 关键原则）

- 关键字段缺失 → 阻断计算
- 非关键字段缺失 → 标记并允许继续
- 可推导字段缺失 → 自动推导或人工补充
- 数据表缺失 → 拒绝项目直接成本核算
- 所有人工操作必须记录日志

---

### 2.7 成本核算逻辑（Cost Engine）

**直接生产成本 =**
- 材料成本  
- + 配件成本  
- + 加工劳务成本  
- + 运费 / 安装费  

> 计算过程必须可追溯、可复算，禁止黑盒计算。

---

### 2.8 结果输出与可视化（MVP）

V0.1 输出内容包括：
- 多表合一的成本明细表（Detail）
- 成本结构分析（材料 / 配件 / 人工占比）
- 直接生产成本汇总值

支持本地导出：
- Excel
- PDF

---

### 2.9 数据留存与扩展性要求

系统需以结构化方式存储历史成本数据，以支持未来：
- 成本对比分析
- 经验估算
- 报价辅助决策

> V0.1 不强制实现分析功能，但数据结构需支持扩展。

---

### 2.10 安全与部署原则（约束性需求）

- 系统仅部署于 **公司内网**
- 不进行公网穿透
- 数据仅存储于：
  - 本地服务器
  - 专用电脑
- 定期本地备份
- 支持离线恢复
