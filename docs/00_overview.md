# 产品成本统计系统 · 总览（V0.1）

## 1. 系统背景与问题定义

在制造企业的日常经营中，**产品直接生产成本**是报价、投标、决策与复盘的基础数据。然而在实际业务中，企业普遍面临以下现实问题：

### 1.1 成本数据来源分散，缺乏统一证据链

- 材料、配件、加工费、运费等成本数据分散在多个 Excel 文件中
- 文件由不同部门分别维护（设计 / 采购 / 生产 / 物流）
- 文件格式、字段、命名规则不统一
- 历史版本易被覆盖或散落在个人电脑中

**结果：**
- 成本结果无法回答“基于哪一份原始数据计算”
- 不具备审计、复盘和追责能力

---

### 1.2 Excel 人工维护导致数据质量不可控

在 Excel 驱动的成本核算流程中，常见问题包括：

- 关键字段缺失（数量、单价、重量、小计）
- 数值关系错误（数量 × 单价 ≠ 小计）
- 负数、单位混乱
- 同一物料 / 配件存在多种名称写法
- 组合采购（bundle）难以被正确核算

**结果：**
- 核算严重依赖人工经验
- 错误难以及时发现
- 数据无法规模化复用

---

### 1.3 人工修正频繁，但缺乏审计与责任归属

为了完成核算，实际工作中往往需要：

- 人工补全字段
- 人工修改单价或小计
- 人工“确认可接受”的异常数据

但这些修改通常直接发生在 Excel 中：

- 无修改记录
- 无操作者信息
- 无修改原因说明

**结果：**
- 成本结果不可解释
- 出现问题无法追责
- 不适合作为报价或投标依据

---

### 1.4 成本结果不可复现、不可冻结

常见情况包括：

- 同一产品在不同时间核算，结果不一致
- 原始文件被覆盖或修改
- 无法还原“当时是基于哪些文件算出的成本”

**结果：**
- 成本结果不具备稳定性
- 无法作为业务事实长期引用

---

### 1.5 异常处理流程混乱，效率低下

- 异常项需要人工逐一沟通
- 无系统化的错误提示和修改入口
- 多轮往返修改容易引入新错误

**结果：**
- 核算周期长
- 人工沟通成本高
- 错误风险叠加

---

## 2. 系统目标（V0.1）

本系统的目标**不是简单算出一个数字**，而是：

> **将“产品直接生产成本”构建为一个：**
> - 可溯源  
> - 可校验  
> - 可审计  
> - 可复现  
> - 可冻结  
> 的业务事实

---

## 3. 核心设计思想

### 3.1 文件即证据（FileRecord）

- 所有成本数据均来源于 FileRecord
- 文件具备：
  - 版本号
  - 上传人
  - 上传时间
  - 校验状态
  - 锁定状态
- 成本计算只能基于 **parse + validate 通过的文件**

---

### 3.2 Item 是最小可审计单元

- 每一行数据解析为一个 Item（Material / Part / Labor / Logistics）
- Item 具备：
  - 独立状态（ok / warning / confirmed / blocked）
  - 明确的错误原因（error_code + message）
  - 审计日志（AuditLog）

---

### 3.3 校验 ≠ 修复，人工行为必须被显式确认

- ValidationService 只负责：
  - 判定是否可信
  - 给出问题清单
- ItemEditService 承担：
  - 人工修正
  - 人工确认
- 系统不会“悄悄帮你改对”

---

### 3.4 成本结果是快照（CostSummary）

- CostSummary 是一次完整核价的**不可变快照**
- 每个 CostSummary：
  - 明确引用的 FileRecord 版本
  - 生成后不可修改
  - 支持被新版本替代（replaced）
- 被引用的 FileRecord 会被锁定，防止证据污染

---

## 4. V0.1 功能范围

### 4.1 已支持能力

- 用户注册 / 登录
- 项目创建与管理
- 文件上传（Material / Part / Labor / Logistics）
- 文件版本管理
- Excel 自动解析
- 数值与规则校验
- 异常项人工修正与确认
- 人工物流费用录入（Manual Logistics）
- 成本快照生成（CostSummary）
- 成本统计表生成（DataFrame / Excel）

---

### 4.2 明确不做（V0.1）

- 权限体系 / 组织架构
- 自动分摊算法（bundle 分摊）
- 复杂统计分析
- BI / 可视化大屏
- ERP / 财务系统对接

---

## 5. 一句话总结

> 本系统解决的不是“算不算得出成本”，  
> 而是：
>
> **成本能不能被相信、被解释、被复现。**

---

## 6. 后续阅读建议

- `01_domain_models.md`：核心数据模型说明
- `02_services.md`：服务
