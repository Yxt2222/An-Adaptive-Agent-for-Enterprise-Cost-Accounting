# 业务流程说明（v0.1）
## 主业务流程（Happy Path）

1. 用户注册并登录系统
2. 创建项目，作为一次成本核算的业务上下文
3. 按类别上传成本相关文件（材料 / 配件 / 加工 / 物流）
4. 系统自动完成文件解析（Parse）与数据校验（Validate）
5. 人工修正或确认异常数据
6. 所有参与核价的文件校验通过后，生成 CostSummary（成本快照）
7. 生成并下载产品直接生产成本 Excel 报告

---

## 流程细化说明（System Behavior）

### 1. 用户注册与登录

**注册必填字段：**
- `account`
- `password`

**可选字段：**
- `display_name`
- `email`
- `phone_number`

用户注册成功后可登录系统并进行后续操作。

---

### 2. 项目创建

项目用于承载一次完整的成本核算流程。

**必填字段：**
- `raw_name`

**可选字段：**
- `business_code`
- `contract_code`
- `spec_tags`

项目创建后，系统会自动维护项目的名称规范化状态与编号校验状态。

---

### 3. 文件上传（FileRecord）

用户在项目上下文中按类别上传文件：

- `material_cost`
- `part_cost`
- `labor_cost`
- `logistics_cost`

此外，系统支持以下**不参与核价的参考文件**：

- `material_plan`
- `part_plan`

上述 plan 类型文件：
- 仅生成 FileRecord
- 不解析为 Item
- 不参与成本计算

---

### 4. 文件解析（Parse）

解析阶段仅判断：

> **文件是否可被系统正确读取，以及是否具备必要的列结构**

解析结果为：

- `parsed`：文件可读取，列名满足最低结构要求
- `failed`：文件无法读取或列名缺失

解析失败的文件不会进入后续校验与核价流程。

文件校验显式规则：
material_plan：可上传，不做校验。
part_plan：可上传，不做校验
material_cost需要具备以下列名： "名称", "规格型号", "数量", "单位", "材质", "参考重量\n（kg）", "单价", "小计"
part_cost需要具备以下列名："名称", "规格型号", "数量", "单位", "单价", "小计"
labor_cost需要具备以下列名： "班组（外协单位）", "数量", "单位", "单价", "加工费", "吨位奖金", "箱梁攻丝费、行走、液压站组装费、溜槽补助", "小计"
logistics_cost需要具备以下列名："类型", "备注", "小计"

---

### 5. 数据校验（Validate）

#### 5.1 Item 级校验（最小校验单元）

Excel 中的 **每一行数据** 会被解析为一个 Item，并作为最小校验单位。

Item 校验状态定义如下：

| 状态 | 含义 |
|----|----|
| blocked | 数据链不完整或存在严重错误，禁止参与核价 |
| warning | 数据不完整但已给出小计，需要人工确认 |
| ok | 数据完整、数量关系正确，系统已校验通过 |
| confirmed | 原 warning 项已由人工确认 |

---

#### 5.2 完整性校验（兜底路径）

以下字段缺失会导致数据链不完整：

| Item 类型 | 关键字段 |
|----|----|
| materialitem| '参考重量\n（kg）',"单价", "小计"|
| partitem|"数量", "单价", "小计"|   
| laboritem | "数量", "单位", "单价", "吨位奖金","箱梁攻丝费、行走、液压站组装费、溜槽补助","小计"|
|logisticsitem|"小计”|

---

#### 5.3 非负性校验

以下字段出现负数将直接判定为 `blocked`：

| Item 类型 | 关键字段 |
|----|----|
| materialitem| '参考重量\n（kg）',"单价", "小计"|
| partitem|"数量", "单价", "小计"|   
| laboritem | "数量", "单价", "吨位奖金","箱梁攻丝费、行走、液压站组装费、溜槽补助","小计"|
| logisticsitem|"小计”|

---

#### 5.4 数量关系校验

| Item 类型 | 规则 |
|----|----|
| materialitem|(0.001) * '参考重量\n（kg）' * "单价" = "小计"|
| partitem|"数量" * "单价" = "小计"|   
| laboritem | "加工费" = "数量" * "单价";"吨位奖金" + "箱梁攻丝费、行走、液压站组装费、溜槽补助" + "加工费" = "小计"|
| logisticsitem| 无数量关系限制 |

---

### 6. 人工修正与确认

- 所有 `blocked` 和 `warning` Item 会返回给前端
- 用户只能修改**允许修改的字段**
- 所有修改行为都会被 AuditLog 记录
- 人工确认会将 `warning` → `confirmed`

---

### 7. CostSummary 生成（成本快照）

当 **所有参与核价的 FileRecord 均处于 `ok / confirmed` 状态** 时：

- 系统生成新的 CostSummary
- 被引用的 FileRecord 会被锁定
- 旧的 CostSummary（如存在）会被标记为 `replaced`

CostSummary 一经生成即不可修改，只能被新版本替代。

---

### 8. 报告生成

基于 `active` 状态的 CostSummary：

- 系统生成产品直接生产成本统计表（DataFrame）
- 可导出为 Excel 文件供下载
- 报告不入库，仅作为展示与交付结果

---

## 重要说明（不可逆约束）

- 成本快照一经生成不可修改
- 文件被快照引用后不可直接编辑
- 若发现数据问题：
  - 需重新逐个上传全部**四类表格**
  - 系统将生成新的 CostSummary 并自动建立替代关系

