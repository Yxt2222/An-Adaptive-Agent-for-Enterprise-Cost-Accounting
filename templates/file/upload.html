{% extends "base.html" %}

{% block title %}上传文件 - 核价系统{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="mb-6">
        <a href="{{ url_for('project.detail', project_id=project.id) }}" class="text-blue-600 hover:text-blue-800 flex items-center">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            返回项目详情
        </a>
        <h1 class="mt-4 text-3xl font-bold text-gray-900">上传文件</h1>
        <p class="mt-2 text-sm text-gray-600">项目: {{ project.raw_name }}</p>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <form method="POST" action="{{ url_for('file.upload_file', project_id=project.id) }}" enctype="multipart/form-data" class="space-y-6">
            <!-- 文件类型选择 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">选择文件类型 <span class="text-red-500">*</span></label>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="file_type" value="material_cost" required class="mr-3" {% if request.args.get('file_type') == 'material_cost' %}checked{% endif %}>
                        <div>
                            <div class="font-medium text-gray-900">材料成本表</div>
                            <div class="text-sm text-gray-500">材料采购成本数据</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="file_type" value="part_cost" class="mr-3" {% if request.args.get('file_type') == 'part_cost' %}checked{% endif %}>
                        <div>
                            <div class="font-medium text-gray-900">配件成本表</div>
                            <div class="text-sm text-gray-500">配件采购成本数据</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="file_type" value="labor_cost" class="mr-3" {% if request.args.get('file_type') == 'labor_cost' %}checked{% endif %}>
                        <div>
                            <div class="font-medium text-gray-900">人工成本表</div>
                            <div class="text-sm text-gray-500">加工费用数据</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="file_type" value="logistics_cost" class="mr-3" {% if request.args.get('file_type') == 'logistics_cost' %}checked{% endif %}>
                        <div>
                            <div class="font-medium text-gray-900">物流成本表</div>
                            <div class="text-sm text-gray-500">运费和安装费数据</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="file_type" value="material_plan" class="mr-3">
                        <div>
                            <div class="font-medium text-gray-900">材料计划表（仅存档）</div>
                            <div class="text-sm text-gray-500">设计部材料清单，不参与成本计算</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="file_type" value="part_plan" class="mr-3">
                        <div>
                            <div class="font-medium text-gray-900">配件计划表（仅存档）</div>
                            <div class="text-sm text-gray-500">设计部配件清单，不参与成本计算</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 文件上传区域 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">选择文件 <span class="text-red-500">*</span></label>
                <div x-data="{ file: null, dragging: false }" 
                     @dragover.prevent="dragging = true"
                     @dragleave.prevent="dragging = false"
                     @drop.prevent="handleDrop($event)"
                     class="border-2 border-dashed rounded-lg p-8 text-center transition-colors"
                     :class="dragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300'">
                    <input type="file" name="file" accept=".xlsx,.xls" required
                           @change="file = $event.target.files[0]"
                           x-ref="fileInput"
                           class="hidden" id="file-input">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="text-gray-600 mb-2">
                        <label for="file-input" class="text-blue-600 hover:text-blue-800 cursor-pointer underline">点击选择文件</label>
                        或拖拽文件到此处
                    </p>
                    <p class="text-sm text-gray-500" x-show="file">
                        已选择: <span class="font-medium" x-text="file?.name"></span>
                    </p>
                    <p class="text-xs text-gray-400 mt-2">支持格式: .xlsx, .xls | 最大大小: 10MB</p>
                </div>
            </div>

            <!-- 文件要求说明 -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-gray-900 mb-2">文件要求</h3>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li>• 支持格式: .xlsx, .xls</li>
                    <li>• 文件大小限制: 10MB</li>
                    <li>• 材料成本表必需字段: 名称、规格型号、数量、单位、材质、参考重量(kg)、单价、小计</li>
                    <li>• 配件成本表必需字段: 名称、规格型号、数量、单位、单价、小计</li>
                    <li>• 人工成本表必需字段: 班组（外协单位）、数量、单位、单价、加工费、吨位奖金、箱梁攻丝费等、小计</li>
                    <li>• 物流成本表必需字段: 类型、备注、小计</li>
                </ul>
            </div>

            <!-- 提交按钮 -->
            <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                <a href="{{ url_for('project.detail', project_id=project.id) }}" 
                   class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    取消
                </a>
                <button type="submit" 
                        id="submit-btn"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    上传
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 全局函数：处理拖拽文件
function handleDrop(event) {
    event.preventDefault();
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            // 创建新的 DataTransfer 对象并添加文件
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(files[0]);
            fileInput.files = dataTransfer.files;
            
            // 触发 change 事件以更新 Alpine.js 状态
            const changeEvent = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(changeEvent);
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const fileInput = document.getElementById('file-input');
    const submitBtn = document.getElementById('submit-btn');
    
    // 表单提交验证
    if (form) {
        form.addEventListener('submit', function(e) {
            // 检查文件是否已选择
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                e.preventDefault();
                alert('请先选择文件');
                if (fileInput) fileInput.focus();
                return false;
            }
            
            // 检查文件类型是否已选择
            const fileType = document.querySelector('input[name="file_type"]:checked');
            if (!fileType) {
                e.preventDefault();
                alert('请选择文件类型');
                return false;
            }
            
            // 显示上传中状态
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '上传中...';
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        });
    }
});
</script>
{% endblock %}

